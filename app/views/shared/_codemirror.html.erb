<%=stylesheet_link_tag "codemirror/lib/codemirror"%>
<%=javascript_include_tag "codemirror/lib/codemirror"%>
<%=javascript_include_tag "codemirror/mode/xml/xml"%>
<%=javascript_include_tag "codemirror/addon/display/display/panel"%>
<%=javascript_include_tag "codemirror/addon/hint/show-hint"%>
<%=javascript_include_tag "codemirror/addon/hint/xml-hint"%>
<%=javascript_include_tag "codemirror-buttons/buttons"%>

<% if @page && !@page.ai_plaintext.blank? %>
  <script>
    var ai_plaintext = <%= raw(@page.ai_plaintext.to_json) %>;
    var ai_plaintext_caveat = <%= raw(t('.ai_plaintext_caveat').to_json) %>;

    function appendAiPlaintext(cm, pred) {
      var currentText = cm.getValue();
      // append ai_plaintext to the end of the current text
      cm.setValue(currentText + ai_plaintext_caveat + "\n" + ai_plaintext);
      cm.markClean();
    }; 
    document.getElementById("copy-ai-plaintext").addEventListener("click", function() {
      appendAiPlaintext(myCodeMirror);
      // now disable the button
      $('#copy-ai-plaintext').prop('disabled', true);
    });

  </script>
<% end %>

<script>
  var button_config = [
    <% @collection.editor_buttons.each do |button| %>
      {
        hotkey: '<%= button.hotkey %>',
        class: '<%= "editor-buttons-#{button.key}" %>',
        label: '<%= "#{button.key}" %>',
        tooltip: '<%= t(".#{button.key}_description", default: button.key) %>',
        callback: function (cm) {
          var selection = cm.getSelection();
          cm.replaceSelection('<%= button.open_tag %>' + selection + '<%= button.close_tag %>');
          if (!selection) {
            var cursorPos = cm.getCursor();
            cm.setCursor(cursorPos.line, cursorPos.ch - <%= button.cursor_offset %>);
          }
          <% if button.has_attribute %>
            else {
              var cursorPos = cm.getCursor();
              cm.setCursor(cursorPos.line, cursorPos.ch - <%= button.cursor_offset %> - selection.length - 2);
            }
          <% end %>
        }
      },
    <% end %>
  ];

  var fromthepage_tags = {
    "!top": ["abbr", "add", "catchword", "cb", "date", "del", "expan", "figure", "footnote", "gap", "head", "hi", "ins", "lb", "marginalia", "milestone", "reg", "stamp", "sub", "sup", "supplied", "table", "unclear", "u", "strike", "span", "a", "i"],
    abbr: { attrs: { expan: null}},
    add: { children: ["u", "s", "hi"] },
    cb: { attrs: { "n": null } },
    date: {attrs: { when: "YYYY-MM-DD" }, children: ["hi", "unclear", "gap"] },
    expan: {attrs: { abbr: null }},
    figure: { attrs: { "type": ["hr", "postmark", "seal"] }},
    footnote: { attrs: { marker: null } },
    head: { attrs: { depth: 2 }},
    hi: { attrs: { "rend": ["bold", "italic", "str", "sub", "sup", "underline"]}},
    ins: { children: ["u", "s", "hi"]},
    lb: { attrs: { "break": "no"}},
    milestone: { attrs: { "unit": ["column"], "n": null}},
    reg: {attrs: { orig: null }},
    row: { children: ["cell"] },
    stamp: { attrs: {"type": ["clerical", "postage", "revenue"]}},
    sup: { children: ["u", "s"] },
    table: { attrs: {"rend": ["rules"]}, children: ["row"] }
  }

  function completeAfter(cm, pred) {
    var cur = cm.getCursor();
    if (!pred || pred()) setTimeout(function() {
      if (!cm.state.completionActive)
        cm.showHint({completeSingle: false});
    }, 100);
    return CodeMirror.Pass;
  }

  function completeIfAfterLt(cm) {
    return completeAfter(cm, function() {
      var cur = cm.getCursor();
      return cm.getRange(CodeMirror.Pos(cur.line, cur.ch - 1), cur) == "<";
    });
  }

  function completeIfInTag(cm) {
    return completeAfter(cm, function() {
      var tok = cm.getTokenAt(cm.getCursor());
      if (tok.type == "string" && (!/['"]/.test(tok.string.charAt(tok.string.length - 1)) || tok.string.length == 1)) return false;
      var inner = CodeMirror.innerMode(cm.getMode(), tok.state).state;
      return inner.tagName;
    });
  }

  var myCodeMirror = CodeMirror.fromTextArea(
    document.getElementById("<%= textarea %>"),
    {
      lineNumbers: true,
      mode: "xml",
      extraKeys: {
        "'<'": completeAfter,
        "'/'": completeIfAfterLt,
        "' '": completeIfInTag,
        "'='": completeIfInTag,
        "Ctrl-Space": "autocomplete",
        "Tab": "autocomplete"
      },
      lineWrapping: true,
      hintOptions: {schemaInfo: fromthepage_tags},
      buttons: button_config,
      inputStyle: 'contenteditable',
      spellcheck: <%= @collection.enable_spellcheck %>,
      rtlMoveVisually: true,
      direction: "<%= text_direction %>",
    });
    // track editing for volunteer hours
    myCodeMirror.on("change", function(instance, changeObj) {
      sendActiveEditing()
    });

    //var canonicalSubjectTitles = <%= raw(canonical_subjects_for_autocomplete.to_json) %>;

    var canonicalSubjectTitles = ["Richard Whitehead","wheat","plowing","rain","Jefferson Davis","freezing","sleet","Joseph A. Whitehead","unclear","1845 March 14th Malipa?","Jeremiah Hunt Graves","pond","frost","Danville, Virginia","Richmond","corn","John Clark","Mr Moorfield","New House","Smith","Keen's Sawmill","negro house","post office","Allan","Mr Roland","Sandy","Green","Wyatt","Government Stables","Abraham","Mrs Womack","snow","T C Green","William H Waller","Pittsylvania Court House ","Philip L. Grasty","Pannill \u0026 Dickenson","E. Y. Wimbish","William Worsham","John Worsham","Pallison Boxley","Abraham C. Shelton","William L. Pannill","Martha Vaughan","William Crews","Elias Laine","Richard Dalton","Biram Lay","Daniel King","Daniel Johns","George Dixon","William Bybee","Thomas East, Sr.","James Shields","Clerk of Pittsylvania","Stephen Dove","Alexander A. S. Garrotte","Joseph T. Johns","James P. Stone","Parskid Keatts","Amos Faris","Jane W. Grasty","Nelly Neale","Jennings Thompson","Jeremiah McCullock","Hyram \u0026 Dabney","Wyatt \u0026 Bybee","Jane Faris","David Neale","Sally Tucker","Samuel Pannill","Daniel Fisher","William F Smith","James M. C. Alexander","Ellender Neale","Hillary Lain","Dabney Bybee","Sarah B. M. Smith","Samuel T. Miller","Henry Templeton","Polly Fisher","John S. Lewis","Sockey Fisher","Nancy Fisher","John Neale","George Bruce","Lewis Yates","Nancy Neale","James Murphy","Hamon Freeman","Daniel Dejarnett","Francis Irby","Allen Scruggs","Jas B Faris","Miss McCullock","Elizabeth Vaughan","Lockey Roark","John D Hunt","Charles J. Clement","David Hunt","Martha E. Hunt","James C. Hunt","James Fletcher","Mr Keeling (workman)","Daniel Martin","Moton Tuck","Joseph East, Sr.","Edmund Johns","Ann B Miller","Edmond Fitzgerald","Jonathan J Bentley","Robert H. Bentley","Mrs. Newton Farmer","William Myers","Demarcus Lain","Ruth T. Hunt","John Tucker","Albert Waddel","William Cox","Lucy Ann Clement","Chaney Barksdale","James D. Moon","Pride Hunt","Doran Hunt","Aspen Grove","Doctor John M. Clopton","Caleb Reynolds","Mrs Hunts Billy","James Crowder","William C. Grasty","Doctor Rawley White","Littleberry Lewis","William Neale","David Berger","Meadsville","Dennis Sampson","Paul Vaughan","John L. Glenn","Samuel Worsham","George W. Coleman","Martha Overby","Fanny Worsham","Jordan","Capt Fitzgeralds plantation","Henry Arnold","John’s branch","hauling oats","Patsy Tucker","John Lain","Armistead Myers","Mordecai Hagood","V. R. Simpson","Oak Hill Plantation","Captain Jacob Graves ","Andrew Thompson","Jane Stanfield","Ben","Grief Miller","Mr. Tarpley","William Burnett Jr","John Myers","William Johnson","William Tucker","Henry Smith","Doctor John Sutphen","Waggon Account","Andrew Crews","Abraham Neale","Doctor Charles Miller","Jonah Kelly","William Peake","Benjamin F. Lain","Captain George Gilbert","James East","Talton Haley","Sarah W. Coleman","John Haley","David Pannill","David P. Miller","Archibald W Worsham","John D. Coleman","Daniel C. Ragsdale","James P. Lewis","George W. Coleman (estate)","William Dews Sons","Hiram Wyatt","John D Owen","Ephraim G Lewis","Lucy Crews","John William Waller","M. A. E McCullock","Pittsylvania County","Jeremiah White Graves","Savings Bank of Pittsylvania Court House","Robert W Harris","Samuel Augustine Walkup","leather","Samuel Fitzgerald","Elder J . J. James","Doctor Rice","Martha Neale","William Irby","Thompson \u0026 Pritchet","Farmers and Merchants Savings Bank","Martha J. McCullock","Sarah J. McCullock","Walter Evans","James M. Harris","Francis McCullock","Fountain Wyatt","Cobbs Ned \u0026 Scothman","M. N. Neale","F. Neale","Thomas W. Anderson","Robert N. Lee","William A. Miller","Samuel S. Miller","Catharine S. Graves","James M Fitzgerald","Sarah Crews","Wm? Evans","Jesse Arnold","granary","Capt John Hunt","Federick","Fannie White Graves","Jeremy","Stony Point","Malissa","Bud Faris","Mr Miller","Henry Clay","Big Henry","Mrs Jno Tucker","Bro Wm Dews","Mrs Ephraim Lewis","Mr Montgomery","Mr John R Taylor","Mr James","Strait Stone","Epp","Mr. Johnson","Nat Spencer","Mr Johnson","Mrs Smith","John McHany","Colley Bradley","Lila","Phil","Fed","Ann","Mr Overby","Moseley","Mr Lewis","Mrs Scruggs","Pleasant","Colo Smith","Sally Brown Hunt","Henry","Alice Hunt","little Henry","Nancy Hunt Graves","Big Henry\\Big Henry","claiborne","Milly Ann","little","Jeremiah Hunt","Mrs Hunt","Jane","alse","Kitty","Allen","Mr Jas Murphy","Jas C. Hunt","Joseph M Yates","Chris Lain","Judge Windfield","Brother Lacy","Brother Glass","Ned Cobbs","Francis Blanks","Mr Smith","Nancy Neal","Joseph Moses","Mrs McHaney","Sallie Hunt Graves","Mr Starkey","John Keatts","Silas Marshall","Mr Bybee","Mr Banks","Jorden","Lowry","Abram","Buck","Dick","Alex","Major Boler","Harry Dalton","Richard","Wyatt Hunt","C Keatts","Tom","William","Sam Gilbert","Sam Gilbert's wife","Mr Grasty","James Purphy","William H. Irby","Mr Neals","Mr Neal","Mr John R. Taylor","Birchet","Birche","William Shields","Sallie Hunt Grave's children"," Sam Gilbert","Mrs Hunt","Aaron Smith","Charles Miller","Caroline Monroe","Mrs Wyat","Charles Lovelace","Mr Keatts","Thomas Lain","Mrs Wyatt","El","Peggy","Tom Kelley Wyatt","Billy Hunt","Abram Dews","Sam Dews","Henry Brooks","Susan Roark","Rhoda","Edward Bybee","Abram Glen","Edd Fitzgerald","Mrs Worsham","Capt Wooding","Roland","Daniel Motley","Mr Hargrave","William Walker Moses","claiborne's son","Mr McHaney","Jacob P Graves","Jonathan Graves","Alonzo Hunt","Mott Graves","Court House","Elvira","Bro Stone","Chalk Level","Jesse Pitts","Phi","Lucy Ann Clement's children","Mr Pidlar","Charlotte VA","Mrs Scrugs","abbot","Bro Webb","Richard Waln","Mr Cotes","Republican Grove","Mr. Spencer Keeling","Demarcas Lain","John J Lain","Mr Wm Collins","Mr Hanfield","Mary Stone","James T. McLaughlin","Mrs Smyth","John J. Lain","Bro Lovelace","Wm Lovelace","Joel Hubbard","John","Stony Poin","Mrs Hun","Mrs Hendrick","Mrs Stanfield","Catharine S.Graves","Jacob P. Graves","Mr Stanfield","Bill","Clabe","Mary Smith","Water Loo","Lucinda Smith","Cedar Hill","J.A. Pringle","Mountain Spring","John Keatss","Wm","Randol","Charlotte Hodnette","Jorden Graves","Mount Airy","Cedar Hil","Edge Hill","New London Academy","Mr Woodings","Clabe's wife","Lucinda","Mr Wooding","Leesville","Charlotee VA","Stoney Point","Greenfield","Mary Mosely","Lynchg","CA Hunt","Mrs Hunts","Pittsylvania Court House (Chatham, Virginia)","Milton","Mrs. Neal","Mr Dove","William DewsMr. Wm Dews","William Dews","Joseph Whitehead","RichardWhitehead","Capt Woodings","Liza Wooding","Capt Whitehead","Campbell CH","Benjamin F. Lain Mr. Lain","Rice","Riceville","Miss Fishers","HenrySmith","Wm B. Averett","Ezekiel East","Colo Dickinson","Pineville Academy","Miss L Wilson","Mrs John Clark","Talton","John G. Lewis","Jermiah Hunt Graves","Orange County","Charlottesville","Louisa CH","Cartersville","Mr Crews","Mr. Strickland","Misses Albright","Shernerd","Joe","Abysom Lea","Jerry Smith","Uncle Jerry","Daniel Hunt","Nicy","Morris","Peg","Cally","John G. Lewis Mr Lewis’s","Mr. McDaniel","Mr Jones","Thomas Templeton","Mrs Garrott","William H Plunket","Miles Tucker","Jno Tucker","Jno Hagood","Bro Angel","Bro Yates","Mrs Neal","William C. Shelton","Hillfield Plantation","Thomas East, Jr.","Mary P. McCullock","Mrs Lovelace","Mr Bagby","Mr John Ward","Martha Dews","Wm Collins","Free Patrick","Mr Collins","John Hodnett","Bro Sampson","Fauquier County","Doctor Lynn","JWG's children","JWG's chidlren","Green field","Harriet","William H Plunket","Ennis","Morton Pannill","Bro Angle","Charlotte, Virginia","Mrs Walkup","Sarah W. Coleman's Kit and Elizabeth McCullock's Kit","Colo Smith's Booker and Edmond Fitzgerald's Booker","Bro Simpson","Booker","Katherine Ophelia","Katherine Ophelia Graves","Miss Ruths","James Whitehead","Robert W HarrisRobt Harris","James McCullock","Mrs Crews","St. Andrews","BroStone","Harmony Grove","William Jennings","Thomas T. Adams","Mr Organ","Thomas Walton","Nancy Clement","Lucy Charles Clement","James Clement","Ezekiel Dews","E Franklin","Richard Smith","George Dove","William Vaughan","Thomas Walker","Mr Brooks","Lynchg this","Robert McCullock","Rose Graves","Lain","Mrs Ohe","H Whitsontide","Aaron Simpson","James","Armstead","Robertson Buchanon","Doctor JC Thompson","George McCullock","John Compton","Mr Moon","Sarah Coleman's Kit","Sarah Colema's Kit","Abram Crews","Sarah Coleman's James","Mr Neale","Harry","H Anderson","Lester Coleman"," John","Overseer","John D. Colelman","Clem","Tom Perry","Montgomery County","John D Owen Jr","Mr Tucker","John D Owne","Mr Haley's slave","Miss Patricks","Oat Hill Plantation","Mrs Farmer","Mr Roach","Isaac","Mr Parham Lewis","JW O'Daniel","Miss E McCullock","Mr Lain","John D Owen Jr's wife","George Cothran","Mrs Robert McCullock","Captain Jacob Graves (Orange)","Lewis Gosney","E W Atkinson","Sam","Crew Miller","Watson Wamack","Mr Logan","Sally T. Hunt","Kentuck Meeting House","Colo Kirby","Laurel Grove","John J Bently","Siety Bently","Constable Ingram","Johnson Farmer","Mr Faris","Mr Grainar","Mr Atkisson","Joshua Hubbard","Carlotte VA","Jeremiah Fitzgerald","Lewis Yeates","Mr Monroe","Kelly","RA Weatherford","Charles Rawley","Garrot E. Smith","C. Lain","Joseph Bybee","Joseph Turner","Hawk Point, MO","Mr Johns","John D Hunt's family","Bransom","William Burnett","Geo Surry","June","John F Patrick","Peggy's mother","Dutch","McCormick","John E F Patrick (FitzPatrick?)","Captail George Gilbert","Mrs William Grasty","J D Hunt","Evard","Jefferson \u0026 Reese","Jno J Corbin","Capt Fitzgerald","Mr Boswell","Emphraim G Lewis","Mrs Thompson","Jno J Corgin","Edmond Fitzgerald's overseer","JB Nowlin","Mr Cobles","Mrs Patrick","Betsy Kelley","Andrews Crews","Brookneal","Jos L Adkinson","Doctor Andrew Thompson","Julia Daniel","Lila's baby","Pallor","Charles","Mr McHaney's Phil","Mr Hurt","Jacob","Mr Lipscomb","Brother Hagood","Buffalo Junction, VA","Jos. L Adkinson","Sally","arch","Mr Vaughan","Mr \u0026 Mrs McCullocks Estate","Susan Daniel","John D Hunts","Nurse Ann","Surveyor Graves","Commissioner","Edmond Johns","Miss Lewis","Doct Johns","Mr. Adams","Mr Ward","Jeremiah William Graves","Patrick Grasty \u0026 Dickenson","Mr. Ward","Mr Mason","Doct Crews","Ann's baby","Mr Harris’s Sam","Mr Pannill","Ephraim G. Lewis","Louisa County","Mrs Clements","Mary Miller","JWG's mother","James Graves","Clover Depot","George Graves","Alabama","Fanny Lain","Daniel R Hunt","David P. Miller?Mr David Millers","Mr Harvey","Rainey M Arnold","Mary Hunt Coleman","Mr McCormick","Jno D Hunt","James M Harris","Mr Mullens","Mr Patterson","John McHaney","Mrs Glass","Joshua Roach","Nannie","Mrs John S Lewis","Robert W Lee","Thomas W. Andersoon","Pallison","Mitchell","Templeton","Mr Cobbs","James McCullock Deceased","Jeremiah McCullock's Estate","AV McKee Troy","Nansemond","Mr Mosley","Colo Coleman","Mr Farris","Daniel Barber","Doctor John H Estes","Bennett","Treadway Forest","Vincent Shelton","Samuel T Shelton","Mr Hancock","Johnson","Eliza","Bottetourt School","Hollins Institute","John D Hunt's Henry","Alex Goodman","James Kelley","Mrs Hunt's Bob","Mrs Hunt's Joshua","Comm Banks","Mar","McCullock heirs","Adams","Martha","Mary Mosley","Elder Burton","Fannie White Graves' children","Fannie White Graves' Eliza","Mr Adams","Mr Witherington","Brother Maran","Julia Boyd","Thomas J Boyd","Meadesville","Malissa's child","Miller's mill","James D. Moon's Negroes","James D. Moon's wife","Mr Mosely","Collins' mill","James Shielsds","Mr Myers","Mr Meyers","Jane's daughter","Beulah Association","Grasty's mill","James Dearing","Pittsylvania County, VA","Mr Richardson","Glenn's mill","Kit","Long Hill","Cotton Jin","Doct White's ","Doct Miller's mill","negroes","Stephen Redgrage","Denmark","Independence MO","California","Mrs Fitzgerald","Gilbert's mill","Colo Smith's plantation","Lucy Ann Clement's Negroes","Mr Monroe's Peter","John D Hunt's young Negroes","Martha Daniel Hunt","Hillfield","Colo Dickenson","F Holy","Mr Rush","Bro. Wm Dews","Doss's tanyard","Mr Hennings","Yates's mill","Faris's mill","Doct White's mill","Martha Overby's children","Elizabeth McCullock's Negroes","Jeremiah McCullock's Negroes","Yates's shop","Captain Jacob Graves's Negroes","Faris’s mill","Dews's mill","Mr Moseley","John D Hunt's estate","Daniel Brown","Indiana","George Edd Coleman","Mary Mosely's will","Mr Lewis's Fletcher","Capt Stephen Clement","Capt Stephen Clement's Negroe","Jenny Lind","Bettie Hunt \u0026 children","Sandy Creek","Springs","Mailissa","Charlotte VA Court House","Mortons Ferry","Staunton River","Chip","Edmond D Johns","John Graves","Greene City, VA","Ruckersville, VA","Martha Neal","Mr Hughes","Negores","Charlotte, VA","Mr McCullock","Mrs Coleman's Negroes","Halifax Court House","Mary Coleman","A McKee","William C Grasty","Pumpkin Pile, Polk County, GA","Pal","Pall","Georgia","James McCullocks Heirs","Mr Overbys","Gordonsville","Charles Graves","Uncle Crenshaw","Mr Prindle","Dews’s mill","Sany","Jordan to [[Captain George Gilbert","Millard Fillmore","Andrew Jackson Donelson","James Buchanan","John C. Breckinridge","Fannie","Nelson","Mr Stone","Halifax","Mrs Lane's Jacob","Sarah Coleman's Negroes","Shanks Worsham","Tar","Dews's shop","burnt","Joshua Shields","Puking","Black vomit","Jordan returned","vomit","Peggy*","Tom Kelley","a little girl","sick","Mr Worsham","Mr Worsham's son","Richard Worsham","Mr Waller","Whitethorn","Richard Jones","Thomas Fitzgerald","Mr Whittle","sore throat","Pain","Pills","Mr Lewis's Negroe","Bob","Miss Neal","John Overby","Pannills Bridge","Pannill's mill","Lucy","Mr Overy","gypsies","Shank Worsham's wife","littleHenry","Hargrave's Store","Coleman's Store","Mr Miller's plantation","uneasy","quite sick","quite low"," very low","childbirth","Fever","injury","chicken pox","common cold","cough","whopping cough","very Sick","death","toothache","rash","miscarriage","verysick","measles","mumps","Typhoid Fever","dizziness","gravely ill","severe burn","Cousin Cleo","Mr Handcock","Capt Clement","Straight Stone","Captain Stephen Clement","Mrs Tucker","Worsham's mill","Dew's dam","Miller's dam","Doct White’s mill","Worsham's dam","Lucy Ann Clement's land","Mr Harris","Fannie White Graves's Jerry","CA Whittemore","Mr Williams","Miss B.","Miss Thompson","Mr D Scruggs","William A Miller","Mr Lovelace","Charles Cocke","Hollin Institute","Doct Lemon","Isaac Davis","Mr Williams \u0026 Isaac Davis","toothacke","abdominal ailment","Mr Dews","Mr Yates","William Williams","swollen jaw","Mr Williams \u0026 Isaac Dews","Martha Smith Overby","Jord -an","Mr Settle","Mr Baily","Pleasant Grove","Campbell","Miss Sarah McCullock","J. A. Pringle","Mr Compton","Malissa's children","Raymond","Doct Mahan","John Hardwick","William King","Miss Emma Mebane","Mr Dallas","Mr Walthall","William G Hollins","Mr Bass","Mr Pigg","Mr Haley","Clement's plantation","John Hodnett's wife","Smith's shop","Ann (F)","Ann (F)'s children","Mr Chumbley","William H. Plunket","Mrs McHaney's land","Mrs McHany","Bybee's plantation","Mr Shields","Anderson Clement","Mr Kelley","recovering","Joel Hardwick","Mr Hackworth","Mr Thompson","Miss Bettie Nunnelle","Jno Singleton","John Shields","Mr Garrot","Mr Forest","Mr Farmer","Plantation","Carpenters in Louisa","Andrew McHaney","Rawly Thompson","John D Hunt's plantation","Uncle Billy","old place","G.D. Neal","G. Pearcy","AB Brown","John Hollins","Elias Lain","William Devin","Catharine Graves","tuberculosis","Giles Dickinson","Susanna D Mills","Andrew L Mills","Catherine Graves","Rheumatism","tooth extraction","swelling","severe pain","Whitehead's mill","Keatts's mill","Banister River","Stinking river","Rev Jno W Kelly","Elk Creek Church","Louisa, VA","Rev John Billingsly","Rev Jno W Kelly","Elk Creek Church","Louisa, VA","Rev John Billingsly","Mr DeJarnett","Grasty's store","Green Grove","Daniel Ring","Mr DJ","Melicia","John Gardner","Mrs Gardner","Augusta County","Mrs Gardner's daughter","Mr Bill","Frances White Graves","John W Kelley","disabled","jaw ache","Isaac W Graves","Capt Jno White","Frances Henderson","John Henderson","Capt Jno ? Clark","Henry W. Faris","Mr Anderson","Jim","Mr Hunt's John","William Cook","Mr Little","Lynchburg, Virginia","Dr.Lewis Yates","Jeremiah Jackson Whitehead","Joseph Webster Whitehead","whiskey","Clifton Graves","cotton","watermelon","cucumbers","William Henry Gilham","Mr H Fletcher","T R Shepherd","Mr Chumbley's wife","Doctor Jno H Estes","Susan Daniel Hunt","Chumbley's wife","Roby's child","clairborne","Jams B Faris","John D Hunt's children","Mrs Hargrave","Jno W Lewis","Fayette Clement","Morton Pannill","H. Wade","Aunt Peggy","Henry Harris","Robert Harris","Demarcus Lain]D Lain","Sarah McCullock","Miller's plantation","Morton ^Pannill","Mr Codey","little sick","Edgehill","Robert","Jerry","Mrs Pannill","Mrs Hunts negroes","Mr Cothran","Mounts Airy"," Jordan","Charles Allen","headache","Mount Calvary","Mrs Chumbley","Thomas Hodnett","Robert Walker","negro woman","Tom Owen","Jonathan Dawson","Mr Moses","Catham","Whilliam H. Plunket","JD Hunt's Ben","Doct Steptoe","John Dew","Mr Chumbley's daughter","Wyatt Walker","Mr Bell","Kitty's baby","Miss Simpson","Mr Hubbard","Cedar Forest","George Robey","James R Graves","Tennessee","Mrs Harris","Capt L W Clement","Mr Barksdale","John Wilson","Avory Mustain","Mrs Templeton","Catalpa, VA","Mr Cothran's brother","Marysville, VA","Robin","Mr Worhsam","Mr Whitehead","Joshua Stone","Joshua Stone's negroes","AB Ruckers","James M Cobbs","Jenny","Mr KirkPatrick","Bedford, VA","Mr Waldron","Bro. Jno","Jonathan Duffy","Henry Wingfield","Mr Poindexter","Jos C Boxley","Billie Jones","Chip Coleman","Stanley Adams","Mr Brown","Bethany","Wm Langhorn","James C. Hunt's daughters","Thornton Langhorn","Ruth T. Hunt's family","aspen","Nathan Penick","T D Neal","Mr Adams Stanley","John D Hunt’s plantation","Lynch John","John D Hunt’s estate","Hanover County, VA","Adophus Tensley","Godden \u0026 apperson","J C Boxley","cholera","James Pannill","Hanover Co., VA","JC Boxley","Melissa","Farmville","James River","Mr Beancon's wife","Mr Deacon","Louisa","Fox","CatharineGraves","Mr Fox","J E Tompkins","Mr McDaniel","Mr Wright","Mr Moor","Mr Roff","Kitty's child","negroe","William Yates","Mr Lain's Tom","Mrs Hendrick's Abram","Aunt Lucy","Bro Thompson","Daniel Hunt's Fanny","William H. Pannill","Yate's mill","Mrs Hunt's house","Stanly Adams","Davis","Mrs Hunt's land","Wilson","Jim Faris","Mr McHaneyMcHaneys","John D Hunt's estate's negroes","Robt Clifton","child","John D Hunt's belongings","Clark","T M Simpson","L. Armstead","AB Ricker","AB Rucker","John P Faris","Doct Thos Haley","neuralgia","amy","apsen Grove","dysentery","JohnP Faris","Mary","Capt J Richard","Lunenburg","Sallie Hargrave","Milley Ann","Martha Daniel","Capt J Richards","Betsy","J Mustain","John Lewis","Capt George Gilbert","Capt Haley","Mr Keen","Andrew J Lewis","Mr Davenport","Mrs Smith's plantation","Mrs Hunt’s Bob","Shenstone","Mr Hargrave's family","Mr J Shields","Mr J Shields' son William","Mr Pillcow","Jonathon Dawson","Mr Lane","Charlie","David P. Miller's Charles","Isaac Overby","Pal's mother","Mrs Shields","James McHaney","Mr Chumbley's child","Emma","David Shields","Mr Bybee's children","Charles W Allen","New Bethel","Edward H Doss","old plantation","Mary James Monroe","Clem \u0026 Arch's child","Mrs Stanly","Jerry^ ^ Smith","Charles to","Dr Steptoe","Mrs Fitzgerald's negroes","Fannie White Graves' negroes","Capt Clement's daughter","Mary \u0026 her children","John shield","Burroughs, Shafer","Jno T Davis","Washington Hotel","J M Langhorn","Mr Scruggs","Mrs Ward","Mary Adams","Mr Burroughs","Tom Templeton","Capt John Hunt \u0026 Mrs Hunt","H W Faris","Capt Tate","BigHenry","alice","Welden Holder","John Hunt","Roby","Taz","D. W. Waller","colic","clem spining","Robert Yates","Doctor Andrews Thompson","Little Henry's mother","Sheriff Witcher","Mr Y Miller","Mr D Logan","Nannie steptoe","George Pannill","Hampton Waller","Caliborne","Molley","Louisa VA","Mrs Johns","Francis Blank","Doctor Thompson's store","Sarah Coleman's children","Garrett Graves","Mr Toot","Mr Tate","Salem VA","Mr Christian","Doct Fletcher","George West","Colo Smith's estate","Washington","Lebanon VA","Russell County VA","Abraham Lincoln","United States","Confederate States of American","Joseph Moses's Jenny","sugar cane","burial","Blunks","F. Wyatt","D.Rice","Dr. E. Y. Wimbish","?","Pannill"];
    
    var subjectAutoListStartAt = null;
    var isAutoCompleteTriggered = false;

    // Helper function to count the number of open and closed brackets
    function countBrackets(text) {
      let openCount = 0;
      let closeCount = 0;

      for (let i = 0; i < text.length; i++) {
        if (text[i] === '[' && text[i+1] === '[') {
          openCount++;
        }
        if (text[i] === ']' && text[i+1] === ']') {
          closeCount++;
        }
      }

      return { openCount, closeCount };
    }

    // display hint of subject linking
    function showSubjectLinkHint(editor, change) {
      if(subjectAutoListStartAt) {
        var suggestions = [];
        var cursor = editor.getCursor();
        var start = cursor.ch - 2; // the start of the hint range
        var currentText = editor.getRange({line: cursor.line, ch: subjectAutoListStartAt}, cursor); // get the current text for hint

        suggestions = canonicalSubjectTitles.filter(item => item.toLowerCase().includes(currentText.toLowerCase()));
  
        editor.showHint({
          completeSingle: false,
          hint: function() {
            return {
              list: suggestions.map(String),
              from: CodeMirror.Pos(cursor.line, subjectAutoListStartAt),
              to: CodeMirror.Pos(cursor.line, cursor.ch)
            };
          }
        });
      }
    }

    // bind autocomplete event
    myCodeMirror.on("change", function(editor, change) {
      var cursor = myCodeMirror.getCursor();
      var token = myCodeMirror.getTokenAt(cursor);
      var lastTwoChars = myCodeMirror.getRange({line: cursor.line, ch: cursor.ch - 2}, cursor);

      // Check for opening and closing brackets
      const text = editor.getValue();
      const { openCount, closeCount } = countBrackets(text);

      // Always show hints on change, but avoid adding multiple listeners
      if(subjectAutoListStartAt && isAutoCompleteTriggered)
        showSubjectLinkHint(editor);

      // Only trigger autocomplete if there are unclosed "[[" brackets
      if (lastTwoChars === '[[') {
        if(!isAutoCompleteTriggered) {
          isAutoCompleteTriggered = true;
          subjectAutoListStartAt = cursor.ch;
          editor.on("inputRead", showSubjectLinkHint);
        }
      }

      if (openCount === closeCount) {
        isAutoCompleteTriggered = false;
        editor.off("inputRead", showSubjectLinkHint);
      }
    });
    
    // give codeMirror with class of respective text direction
    myCodeMirror.getWrapperElement().classList.add("<%= text_direction %>");
</script>