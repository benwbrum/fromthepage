<?xml version="1.0" encoding="UTF-8"?>
<TEI xmlns="http://www.tei-c.org/ns/1.0"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.tei-c.org/ns/1.0 http://www.tei-c.org/release/xml/tei/custom/schema/xsd/tei_all.xsd"
xml:lang="EN"
xml:id="W<%=@work.identifier||@work.id%>">

<teiHeader>
  <fileDesc>
    <titleStmt>
      <title type="full">
        <title type="main"><%= h(@work.title) %></title>
        <title type="desc"><%= h(@work.description) %></title>
      </title>
      <author>
        <persName><%= h(@work.author) %></persName>
      </author>
    </titleStmt>

    <editionStmt>
      <edition><%= t('export.tei.edition_created') %></edition>
      <respStmt xml:id="AU<%= @work.owner.id%>">
        <resp><%= t('export.tei.initial_upload') %></resp>
        <persName><%= h(@work.owner.real_name) %></persName>
      </respStmt>

      <respStmt xml:id="OU<%= @collection.owner.id%>">
        <resp><%= t('export.tei.administrator', collection: @collection.title) %></resp>
        <persName><%= h(@collection.owner.real_name) %></persName>
      </respStmt>

      <% @user_contributions.each do |user| %>
        <respStmt xml:id="U<%= user[:user_id]%>">
          <persName
            <% if user[:real_name].blank? %>
              type="pseudonym"
            <% end %>
            >
            <%= h(user.real_name.blank? ? user.display_name : user.real_name) %>
            </persName>
          <% if user[:edit_count] == 1 %>
            <resp>
              <%= t('export.tei.made_one_edit_on') %>
              <date type="only_edit" when="<%= user[:first_edit].iso8601 %>"><%= user[:first_edit].strftime("%B %e, %Y") %></date>.
            </resp>
          <% else %>
            <resp>
              <%= t('export.tei.made_edits_between', count: user[:edit_count]) %>
              <date type="first_edit" when="<%= user[:first_edit].iso8601 %>"><%= user[:first_edit].strftime("%B %e, %Y") %></date> and
              <date type="last_edit" when="<%= user[:last_edit].iso8601 %>"><%= user[:last_edit].strftime("%B %e, %Y") %></date>.
            </resp>
          <% end %>
        </respStmt>
      <% end %>

      <% if @work.deeds.where(deed_type: DeedType::PAGE_REVIEWED).present? %>
        <% User.find(@work.deeds.where(deed_type: DeedType::PAGE_REVIEWED).pluck(:user_id)).each do |user| %>
          <respStmt xml:id="U<%= user.id %>">
            <resp n="proof_1"><%= t('export.tei.single_proof_by') %></resp>
            <name><%= h(user.real_name || user.display_name) %></name>
          </respStmt>
        <%end%>
      <%end%>

      <% if @export_user %>
        <respStmt xml:id="OU<%= @export_user.id%>">
          <resp n="proof_2"><%= t('export.tei.double_proof_by') %></resp>
          <persName><%= h(@export_user.real_name) %></persName>
        </respStmt>
      <% end %>

    </editionStmt>

    <publicationStmt>
    <publisher><%= t('export.tei.dynamic_tei_export', version: fromthepage_version) %></publisher>
      <availability>
        <p><%= h(@work.permission_description) %></p>
      </availability>
      <date when="<%= Time.now.iso8601 %>"><%= Time.now.strftime("%B %e, %Y") %></date>
    </publicationStmt>

    <sourceDesc>
      <msDesc>
        <msIdentifier>
          <% unless @work.source_location.blank? %>
            <repository><%= h(@work.source_location) %></repository>
          <% end %>
          <% if @work.source_collection_name.blank? %>
            <collection><%= h(@collection.title) %></collection>
          <% else %>
            <collection><%= h(@work.source_collection_name) %></collection>
          <% end %>
          <% unless @work.identifier.blank? %>
            <idno type='external id'><%= h(@work.identifier) %></idno>
          <% end %>
          <% unless @work.source_box_folder.blank? %>
            <idno type='box-folder'><%= h(@work.source_box_folder) %></idno>
          <% end %>
        </msIdentifier>
        <physDesc>
          <p><%= h(@work.physical_description) %></p>
        </physDesc>
        <history>
          <origin>
            <placeName><%= h(@work.location_of_composition) %></placeName>
          </origin>
          <provenance><%= h(@work.document_history) %></provenance>
        </history>
      </msDesc>

      <% unless @person_articles.empty? %>
        <listPerson>
          <% @person_articles.each do |person| %>
            <person xml:id="S<%=person.id%>">
              <persName><%= h(person.title) %></persName>
              <% unless person.uri.blank? %>
                <idno><%= h(person.uri) %></idno>
              <% end %>
              <% unless person.birth_date.blank? %>
                <% clean_birth_date = clean_date_for_when_attribute(person.birth_date) %>
                <event type="birth"<% if clean_birth_date %> when="<%= clean_birth_date %>"<% end %>>
                  <ab><%= h(person.birth_date) %></ab>
                </event>
              <% end %>
              <% unless person.death_date.blank? %>
                <% clean_death_date = clean_date_for_when_attribute(person.death_date) %>
                <event type="death"<% if clean_death_date %> when="<%= clean_death_date %>"<% end %>>
                  <ab><%= h(person.death_date) %></ab>
                </event>
              <% end %>
              <% unless person.race_description.blank? %>
                <trait type="race" subtype="<%= h(person.race_description) %>"/>
              <% end %>
              <% unless person.sex.blank? %>
                <trait type="sex" subtype="<%= h(person.sex) %>"/>
              <% end %>
 
              <% if person.categories %>
                <note type="categorization">
                  Categories:
                  <% person.categories.each do |category| %>
                    <ab>
                      <% category.ancestors.reverse.each do |parent| %>
                        <%  if parent.root?
                              category_class = "#category #root"
                            else
                              category_class = "#category #branch"
                            end
                        %>
                        <ptr ana="<%= category_class %>" target="#C<%= parent.id %>"/> <%= h(parent.title) %> --
                      <% end %>
                      <ptr ana="#category #leaf<%= ' #root' if category.root? %>" target="#C<%= category.id %>"/> <%= h(category.title) %>
                    </ab>
                  <% end %>
                </note>
              <% end %>
              <% unless person.source_text.blank? %>
                <note type="article">
                  <% unless person.source_text.blank? %>
                    <%= raw(xml_to_export_tei(person.xml_text, @context, "S#{person.id}")) %>
                  <% end %>
                </note>
              <% end %>
              <% unless person.bibliography.blank? %>
                <% person.bibliography.split("\n").each do |line| %>
                  <% unless line.blank? %>
                    <bibl><%= h(line.chomp) %></bibl>
                  <% end %>
                <% end %>
              <% end %>
            </person>
          <% end %>
        </listPerson>
      <% end %>

      <% unless @place_articles.empty? %>
        <listPlace>
          <% @place_articles.each do |place| %>
            <place xml:id="S<%=place.id%>">
              <placeName><%= h(place.title) %></placeName>
              <% unless place.uri.blank? %>
                <idno><%= h(place.uri) %></idno>
              <% end %>
              <% if place.categories %>
                <note type="categorization">
                  Categories:
                  <% place.categories.each do |category| %>
                    <ab>
                      <% category.ancestors.reverse.each do |parent| %>
                        <%  if parent.root?
                              category_class = "#category #root"
                            else
                              category_class = "#category #branch"
                            end
                        %>
                        <ptr ana="<%= category_class %>" target="#C<%= parent.id %>"/> <%= h(parent.title) %> --
                      <% end %>
                      <ptr ana="#category #leaf<%= ' #root' if category.root? %>" target="#C<%= category.id %>"/> <%= h(category.title) %>
                    </ab>
                  <% end %>
                </note>
              <% end %>
              <% unless place.source_text.blank? %>
                <note type="article">
                  <% unless place.source_text.blank? %>
                    <%= raw(xml_to_export_tei(place.xml_text, @context, "S#{place.id}")) %>
                  <% end %>
                </note>
              <% end %>
              <% unless place.latitude.blank? %>
                <geo><%= place.latitude %>, <%= place.longitude %></geo>
              <% end %>
              <% unless place.bibliography.blank? %>
                <% place.bibliography.split("\n").each do |line| %>
                  <% unless line.blank? %>
                    <bibl><%= h(line.chomp) %></bibl>
                  <% end %>
                <% end %>
              <% end %>
            </place>
          <% end %>
        </listPlace>
      <% end %>
    </sourceDesc>

  </fileDesc>

  <% unless @other_articles.empty? %>
    <encodingDesc>
      <classDecl>
        <%= raw(tei_taxonomy(@collection.categories.where("parent_id IS NULL"), @other_articles)) %>
      </classDecl>
    </encodingDesc>
  <% end %>


  <profileDesc>
    <% unless @work.recipient.blank? %>
      <correspDesc>
        <correspAction type="sent">
          <persName><%= h(@work.author) %></persName>
        </correspAction>
        <correspAction type="received">
          <persName><%= h(@work.recipient) %></persName>
        </correspAction>
      </correspDesc>
    <% end %>

    <% unless @work.location_of_composition.blank? && @work.document_date.blank? %>
      <creation>
        <% unless @work.location_of_composition.blank? %>
          <placeName><%= h(@work.location_of_composition) %></placeName>
        <% end %>
        <% unless @work.document_date.blank? %>
          <date when="<%= @work.document_date %>"><%= h(@work.document_date) %></date>
        <% end %>
      </creation>
    <% end %>

    <% unless @work.genre.blank? %>
     <textClass>
      <keywords>
       <term type="genre"><%= h(@work.genre) %></term>
      </keywords>
     </textClass>
    <% end %>

    <%unless @work.collection.text_language.blank?%>
      <%code = @work.collection.text_language%>
      <langUsage>
        <language ident="<%=code%>"><%= h(ISO_639.find_by_code(code).english_name) %></language>
      </langUsage>
    <%end%>
  </profileDesc>
  <% unless @work.original_metadata.blank? && @work.metadata_description.blank? %>
    <xenoData>
      <metadata>
        <% unless @work.original_metadata.blank? %>
          <% JSON[@work.original_metadata].each do |element| %>
            <item source="imported">
              <name><%= h(element["label"]) %></name>
              <value><%= h(element["value"]) %></value>
            </item>
          <% end %>
        <% end %>
        <% unless @work.metadata_description.blank? %>
          <% JSON[@work.metadata_description].each do |element| %>
            <item source="user-created">
              <name><%= h(element["label"]) %></name>
              <value><%= h(element["value"]) %></value>
            </item>
          <% end %>
        <% end %>
      </metadata>
    </xenoData>
  <% end %>

  <revisionDesc>
    <listChange ordered="true">
      <% @work_versions.each do |page_version| %>
        <change xml:id="CHG<%= page_version.work_version %>" who="U<%= page_version.user_id %>" when="<%= page_version.created_on.iso8601 %>" target="#P<%= page_version.page_id %>">
          Version <%= page_version.page_version %> of page "<%= h(page_version.page.title) %>":
          <% if page_version.transcription.blank? %>
            <%= t('export.tei.empty_transcript') %>
          <% else %>
            <%= t('export.tei.changes_to_page_transcript') %>
          <% end%>
        </change>
      <% end %>
    </listChange>
  </revisionDesc>
</teiHeader>

<text>
  <body>
    <% @context.translation_mode = false %>
    <% if @work.supports_translation? %>
      <div xml:id="original">
        <% @work.pages.includes(:notes, :ia_leaf, :sc_canvas).each do |page| %>
        <% if @work.sc_manifest %>
          <pb xml:id="FO<%=page.id%>" n="<%=page.position%>" facs="<%= page.sc_canvas.sc_resource_id %>"/>
        <% else %>
          <pb xml:id="FO<%=page.id%>" n="<%=page.position%>" facs="<%= "#{root_url}image-service/#{page.id}/full/full/0/default.jpg" %>"/>
        <% end %>
        <% if @work.pages_are_meaningful? %>
          <div xml:id="<%=page_id_to_xml_id(page.id, @context.translation_mode)%>">
        <% end%>
          <fw type="pageNum"><%= h(page.title) %></fw>
          <% unless page.status_blank? %>
            <%= raw(xml_to_export_tei(page.xml_text, @context, page.id, true))%>
          <% end %>
          <% notes = page.notes %>
          <% if notes && notes.length > 0 %>
            <% notes.each do |note| %>
              <note type='comment' resp="#U<%= note.user_id %>"><%= h(note.body) %></note>
            <% end %>
          <% end %>
        <% if @work.pages_are_meaningful? %>
          </div>
        <% end%>
        <% end %>
      </div>
      <div xml:id="translation">
        <% @context.translation_mode = true %>
        <% @work.pages.includes(:notes, :ia_leaf).each do |page| %>
          <pb xml:id="FT<%=page.id%>" n="<%=page.position%>" facs="<%= page.image_url_for_download %>"/>
        <% if @work.pages_are_meaningful? %>
          <div xml:id="<%=page_id_to_xml_id(page.id, @context.translation_mode)%>">
        <% end%>
          <fw type="pageNum"><%= h(page.title) %></fw>
          <%= raw(xml_to_export_tei(page.xml_translation, @context, page.id, true))%>
        <% if @work.pages_are_meaningful? %>
          </div>
        <% end%>
        <% end %>
      </div>
    <% else %>
      <% @work.pages.includes(:notes, :ia_leaf, :sc_canvas).each do |page| %>
        <pb xml:id="F<%=page.id%>" n="<%=page.position%>" facs="<%= page.image_url_for_download %>"/>
      <% if @work.pages_are_meaningful? %>
        <div xml:id="<%=page_id_to_xml_id(page.id, @context.translation_mode)%>">
      <% end%>
        <fw type="pageNum"><%= h(page.title) %></fw>
        <% unless page.status_blank? %>
          <%= raw(xml_to_export_tei(page.xml_text, @context, page.id, true))%>
        <% end %>
        <% notes = page.notes %>
        <% if notes && notes.length > 0 %>
          <% notes.each do |note| %>
            <note resp="#U<%= note.user_id %>"><%= h(note.body) %></note>
          <% end %>
        <% end %>
      <% if @work.pages_are_meaningful? %>
        </div>
      <% end%>
      <% end %>
    <% end %>
  </body>
</text>
</TEI>
